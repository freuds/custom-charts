version: '3'

tasks:
  default:
    desc: "Display all available tasks for this project"
    silent: true
    cmds:
      - task --list-all

  generate:
    desc: Generate Helm charts
    silent: true
    cmds:
      - |
        for chart in charts/*/Chart.yaml; do
          chart_dir=$(dirname "$chart")
          helm dependency update "$chart_dir" || true
          helm package "$chart_dir" -d docs/
        done
      - helm repo index docs/ --url "https://freuds.github.io/custom-charts/" --merge docs/index.yaml

  lint:
    desc: Lint Helm charts
    silent: true
    cmds:
      - ct lint --config charts/ct.yaml

  lint-all:
    desc: Lint and validate all Helm charts
    silent: true
    cmds:
      - task: lint
      - helm lint charts/cronjob
      - helm lint charts/proxy
      - >
        helm template charts/cronjob |
        kubeconform -kubernetes-version 1.26.0
        -schema-location default
        -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json'
      - >
        helm template charts/proxy |
        kubeconform -kubernetes-version 1.26.0
        -schema-location default
        -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json'

  update-deps:
    desc: Update Helm dependencies
    cmds:
      - helm dependency update charts/cronjob
      - helm dependency update charts/proxy
